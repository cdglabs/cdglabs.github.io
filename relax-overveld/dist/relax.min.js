!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Relax=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){function installArithmeticConstraints(Relax){Relax.arith={};function installRef(target,ref,prefix){target[prefix+"_obj"]=ref.obj;target[prefix+"_prop"]=ref.prop}function ref(target,prefix){return target[prefix+"_obj"][target[prefix+"_prop"]]}function deltas(target){var result={};for(var i=1;i<arguments.length;i+=2){var prefix=arguments[i];var delta=arguments[i+1];if(!isFinite(delta)){continue}var d=result[prefix+"_obj"];if(!d){result[prefix+"_obj"]=d={}}d[target[prefix+"_prop"]]=delta}return result}Relax.arith.ValueConstraint=function(ref,value){installRef(this,ref,"v");this.value=value};Relax.arith.ValueConstraint.prototype.computeDeltas=function(timeMillis){return deltas(this,"v",this.value-ref(this,"v"))};Relax.arith.EqualityConstraint=function(ref1,ref2){installRef(this,ref1,"v1");installRef(this,ref2,"v2")};Relax.arith.EqualityConstraint.prototype.computeDeltas=function(timeMillis){var diff=ref(this,"v1")-ref(this,"v2");return deltas(this,"v1",-diff/2,"v2",+diff/2)};Relax.arith.SumConstraint=function(ref1,ref2,ref3){installRef(this,ref1,"v1");installRef(this,ref2,"v2");installRef(this,ref3,"v3")};Relax.arith.SumConstraint.prototype.computeDeltas=function(timeMillis){var diff=ref(this,"v3")-(ref(this,"v1")+ref(this,"v2"));return deltas(this,"v1",+diff/3,"v2",+diff/3,"v3",-diff/3)}}module.exports=installArithmeticConstraints},{}],2:[function(_dereq_,module,exports){function installGeometricConstraints(Relax){Relax.geom={};function square(n){return n*n}function plus(p1,p2){return{x:p1.x+p2.x,y:p1.y+p2.y}}function minus(p1,p2){return{x:p1.x-p2.x,y:p1.y-p2.y}}function scaledBy(p,m){return{x:p.x*m,y:p.y*m}}function copy(p){return scaledBy(p,1)}function midpoint(p1,p2){return scaledBy(plus(p1,p2),.5)}function magnitude(p){return Math.sqrt(square(p.x)+square(p.y))}function normalized(p){return scaledBy(p,1/magnitude(p))}function rotatedBy(p,dTheta){var c=Math.cos(dTheta);var s=Math.sin(dTheta);return{x:c*p.x-s*p.y,y:s*p.x+c*p.y}}function rotatedAround(p,dTheta,axis){return plus(axis,rotatedBy(minus(p,axis),dTheta))}function setDelta(d,p,scale){d.x=p.x*scale;d.y=p.y*scale}Relax.geom.square=square;Relax.geom.plus=plus;Relax.geom.minus=minus;Relax.geom.scaledBy=scaledBy;Relax.geom.copy=copy;Relax.geom.midpoint=midpoint;Relax.geom.magnitude=magnitude;Relax.geom.normalized=normalized;Relax.geom.rotatedBy=rotatedBy;Relax.geom.rotatedAround=rotatedAround;Relax.geom.setDelta=setDelta;Relax.geom.CoordinateConstraint=function(p,x,y){this.p=p;this.c={x:x,y:y}};Relax.geom.CoordinateConstraint.prototype.computeDeltas=function(timeMillis){return{p:minus(this.c,this.p)}};Relax.geom.CoincidenceConstraint=function(p1,p2){this.p1=p1;this.p2=p2};Relax.geom.CoincidenceConstraint.prototype.computeDeltas=function(timeMillis){var splitDiff=scaledBy(minus(this.p2,this.p1),.5);return{p1:splitDiff,p2:scaledBy(splitDiff,-1)}};Relax.geom.EquivalenceConstraint=function(p1,p2,p3,p4){this.p1=p1;this.p2=p2;this.p3=p3;this.p4=p4};Relax.geom.EquivalenceConstraint.prototype.computeDeltas=function(timeMillis){var splitDiff=scaledBy(minus(plus(this.p2,this.p3),plus(this.p1,this.p4)),.25);return{p1:splitDiff,p2:scaledBy(splitDiff,-1),p3:scaledBy(splitDiff,-1),p4:splitDiff}};Relax.geom.EqualDistanceConstraint=function(p1,p2,p3,p4){this.p1=p1;this.p2=p2;this.p3=p3;this.p4=p4};Relax.geom.EqualDistanceConstraint.prototype.computeDeltas=function(timeMillis){var l12=magnitude(minus(this.p1,this.p2));var l34=magnitude(minus(this.p3,this.p4));var delta=(l12-l34)/4;var e12=scaledBy(normalized(minus(this.p2,this.p1)),delta);var e34=scaledBy(normalized(minus(this.p4,this.p3)),delta);return{p1:e12,p2:scaledBy(e12,-1),p3:scaledBy(e34,-1),p4:e34}};Relax.geom.LengthConstraint=function(p1,p2,l){this.p1=p1;this.p2=p2;this.l=l};Relax.geom.LengthConstraint.prototype.computeDeltas=function(timeMillis){var l12=magnitude(minus(this.p1,this.p2));var delta=(l12-this.l)/2;var e12=scaledBy(normalized(minus(this.p2,this.p1)),delta);return{p1:e12,p2:scaledBy(e12,-1)}};Relax.geom.OrientationConstraint=function(p1,p2,p3,p4,theta){this.p1=p1;this.p2=p2;this.p3=p3;this.p4=p4;this.theta=theta};Relax.geom.OrientationConstraint.prototype.computeDeltas=function(timeMillis){var v12=minus(this.p2,this.p1);var a12=Math.atan2(v12.y,v12.x);var m12=midpoint(this.p1,this.p2);var v34=minus(this.p4,this.p3);var a34=Math.atan2(v34.y,v34.x);var m34=midpoint(this.p3,this.p4);var currTheta=a12-a34;var dTheta=this.theta-currTheta;return{p1:minus(rotatedAround(this.p1,dTheta,m12),this.p1),p2:minus(rotatedAround(this.p2,dTheta,m12),this.p2),p3:minus(rotatedAround(this.p3,-dTheta,m34),this.p3),p4:minus(rotatedAround(this.p4,-dTheta,m34),this.p4)}};Relax.geom.MotorConstraint=function(p1,p2,w){this.p1=p1;this.p2=p2;this.w=w;this.lastT=Date.now()};Relax.geom.MotorConstraint.prototype.computeDeltas=function(timeMillis){var t=(timeMillis-this.lastT)/1e3;this.lastT=timeMillis;var dTheta=t*this.w*(2*Math.PI);var m12=midpoint(this.p1,this.p2);return{p1:minus(rotatedAround(this.p1,dTheta,m12),this.p1),p2:minus(rotatedAround(this.p2,dTheta,m12),this.p2)}}}module.exports=installGeometricConstraints},{}],3:[function(_dereq_,module,exports){var installArithmeticConstraints=_dereq_("./arithmetic-constraints.js");var installGeometricConstraints=_dereq_("./geometric-constraints.js");function Relax(){this.rho=.25;this.epsilon=.01;this.things=[]}Relax.isConstraint=function(thing){return thing.computeDeltas!==undefined};Relax.prototype.add=function(thing){this.things.push(thing);return thing};Relax.prototype.remove=function(unwantedThing){var self=this;this.things=this.things.filter(function(thing){return thing!==unwantedThing&&!(Relax.isConstraint(thing)&&involves(thing,unwantedThing))})};Relax.prototype.clear=function(){this.things=[]};Relax.prototype.getConstraints=function(){return this.things.filter(Relax.isConstraint)};Relax.prototype.doOneIteration=function(timeMillis){if(this.beforeEachIteration){this.beforeEachIteration()}var self=this;var allDeltas=[];this.things.forEach(function(t){if(Relax.isConstraint(t)){var c=t;var deltas=c.computeDeltas(timeMillis);if(hasSignificantDeltas(self,deltas)){allDeltas.push({constraint:c,deltas:deltas})}}});allDeltas.forEach(function(d){applyDeltas(self,d)});return allDeltas.length>0};Relax.prototype.iterateForUpToMillis=function(tMillis){var count=0;var didSomething;var now,t0,t;now=t0=Date.now();do{didSomething=this.doOneIteration(t0);now=Date.now();t=now-t0;count+=didSomething?1:0}while(didSomething&&t<tMillis);return count};function hasSignificantDeltas(relax,deltas){for(var p in deltas){var d=deltas[p];for(var prop in d){if(d.hasOwnProperty(prop)&&Math.abs(d[prop])>relax.epsilon){return true}}}return false}function applyDeltas(relax,patch){for(var p in patch.deltas){var d=patch.deltas[p];for(var prop in d){if(d.hasOwnProperty(prop)){patch.constraint[p][prop]+=d[prop]*relax.rho}}}}function involves(constraint,obj){for(var p in constraint){if(constraint[p]===obj){return true}}return false}installArithmeticConstraints(Relax);installGeometricConstraints(Relax);module.exports=Relax},{"./arithmetic-constraints.js":1,"./geometric-constraints.js":2}]},{},[3])(3)});